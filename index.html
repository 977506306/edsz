<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="max-age=3600"> <!-- 启用1小时缓存 -->
    <title>欢迎访问</title>
    <style>
        .error-container {
            display: none;
            padding: 20px;
            font-family: Arial, sans-serif;
            text-align: center;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    <div id="errorContainer" class="error-container">
        <h1>访问受限</h1>
        <p id="errorMessage">该网站不在允许访问的白名单内</p>
    </div>
    
    <iframe id="contentFrame" style="width: 100%; height: 100vh; border: none; display: none;" loading="lazy"></iframe>

    <script>
        // 域名白名单配置 (添加您允许的域名)
        const WHITELIST_DOMAINS = [
            "wanliwangluo.top",      // 允许wanliwangluo.top及其所有子域名
            "qinm1.1.wanliwangluo.top" // 或仅允许特定子域名
        ];

        // 安全解码Base64 (优化版)
        function safeAtob(encoded) {
            try {
                return atob(encoded.replace(/-/g, '+').replace(/_/g, '/').padEnd(encoded.length + (4 - encoded.length % 4) % 4, '='));
            } catch {
                return null;
            }
        }

        // 检查域名是否在白名单中 (精确匹配版本)
        function isDomainAllowed(url) {
            try {
                const targetDomain = new URL(url).hostname;
                
                // 检查是否有精确匹配的域名
                if (WHITELIST_DOMAINS.includes(targetDomain)) {
                    console.log(`精确匹配成功: ${targetDomain}`);
                    return true;
                }
                
                // 检查是否是白名单中主域名的子域名
                return WHITELIST_DOMAINS.some(allowedDomain => {
                    // 如果允许的是主域名（如example.com），则允许所有子域名
                    if (allowedDomain.split('.').length === 2) {
                        return targetDomain.endsWith(`.${allowedDomain}`);
                    }
                    
                    // 如果允许的是子域名（如sub.example.com），则只允许精确匹配
                    return false;
                });
            } catch (error) {
                console.error('解析URL失败:', error);
                return false;
            }
        }

        // 页面加载后执行
        window.onload = function() {
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            const contentFrame = document.getElementById('contentFrame');
            
            // 从URL参数获取并解码目标URL
            const encodedUrl = new URLSearchParams(location.search).get('u');
            const targetUrl = encodedUrl && safeAtob(encodedUrl);
            
            // 添加调试日志
            console.log('Encoded URL:', encodedUrl);
            console.log('Decoded URL:', targetUrl);
            
            // 快速验证必要条件
            if (!targetUrl || !/^https?:\/\//.test(targetUrl) || !isDomainAllowed(targetUrl)) {
                errorMessage.textContent = `错误: 无效的访问链接 (${targetUrl})`;
                console.error('域名验证失败:', targetUrl);
                return errorContainer.style.display = 'flex';
            }
            
            // 预解析目标域名DNS
            const link = document.createElement('link');
            link.rel = 'dns-prefetch';
            link.href = `//${new URL(targetUrl).hostname}`;
            document.head.appendChild(link);
            
            // 设置iframe加载事件监听
            let loaded = false;
            const showContent = () => {
                if (loaded) return;
                loaded = true;
                contentFrame.style.display = 'block';
                errorContainer.style.display = 'none';
            };
            
            // 成功加载事件
            contentFrame.onload = showContent;
            
            // 错误处理 (优化版)
            contentFrame.onerror = () => {
                errorMessage.textContent = '错误: 无法加载该网站 (可能是由于跨域限制)';
                errorContainer.style.display = 'flex';
            };
            
            // 超时处理 (增加到20秒)
            setTimeout(() => {
                if (!loaded) {
                    errorMessage.textContent = '错误: 加载超时';
                    errorContainer.style.display = 'flex';
                }
            }, 20000);
            
            // 开始加载iframe
            contentFrame.src = targetUrl;
        };
    </script>
</body>
</html>
