<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>欢迎访问</title>
    <style>
        .error-container {
            display: none;
            padding: 20px;
            font-family: Arial, sans-serif;
            text-align: center;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body>
    <div id="errorContainer" class="error-container">
        <h1>访问受限</h1>
        <p id="errorMessage">该网站不在允许访问的白名单内</p>
    </div>
    
    <iframe id="contentFrame" style="width: 100%; height: 100vh; border: none; display: none;"></iframe>

    <script>
        // 域名白名单配置 (添加您允许的域名)
        const WHITELIST_DOMAINS = [
            "example.com",     // 允许example.com及其所有子域名
            "qinm1.1.wanliwangluo.top", // 仅允许sub.example.com，不允许example.com
            "another-site.net" // 允许another-site.net及其所有子域名
        ];

        // 获取URL参数
        function getQueryParam(param) {
            try {
                return new URLSearchParams(window.location.search).get(param);
            } catch (e) {
                console.error('解析URL参数失败:', e);
                return null;
            }
        }

        // 安全解码Base64
        function safeAtob(encoded) {
            try {
                let base64 = encoded.replace(/-/g, '+').replace(/_/g, '/');
                while (base64.length % 4) base64 += '=';
                return atob(base64);
            } catch (e) {
                console.error('Base64解码失败:', e);
                return null;
            }
        }

        // 检查域名是否在白名单中（改进版本）
        function isDomainAllowed(url) {
            try {
                const parsedUrl = new URL(url);
                const targetDomain = parsedUrl.hostname;
                
                // 检查是否有精确匹配的域名（包括子域名）
                if (WHITELIST_DOMAINS.includes(targetDomain)) {
                    return true;
                }
                
                // 检查是否是白名单中主域名的子域名
                return WHITELIST_DOMAINS.some(allowedDomain => {
                    // 如果允许的域名是子域名（包含至少两个点），则不匹配主域名
                    const isSubdomain = (allowedDomain.match(/\./g) || []).length >= 2;
                    if (isSubdomain) {
                        return false;
                    }
                    
                    // 检查是否是主域名的子域名
                    return targetDomain.endsWith(`.${allowedDomain}`);
                });
            } catch (e) {
                console.error('解析URL失败:', e);
                return false;
            }
        }

        // 页面加载后执行
        window.onload = function() {
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            const contentFrame = document.getElementById('contentFrame');

            try {
                const encodedUrl = getQueryParam('u');
                
                if (!encodedUrl) {
                    throw new Error('缺少必要的URL参数 "u"');
                }
                
                const targetUrl = safeAtob(encodedUrl);
                
                if (!targetUrl) {
                    throw new Error('URL解码失败');
                }
                
                // 验证URL格式
                if (!/^https?:\/\//i.test(targetUrl)) {
                    throw new Error('无效的URL格式');
                }
                
                // 检查域名白名单
                if (!isDomainAllowed(targetUrl)) {
                    throw new Error('访问的域名不在允许列表中');
                }
                
                // 加载内容
                contentFrame.src = targetUrl;
                contentFrame.onload = function() {
                    contentFrame.style.display = 'block';
                    errorContainer.style.display = 'none';
                };
                
                // 设置超时处理
                setTimeout(() => {
                    if (contentFrame.style.display !== 'block') {
                        throw new Error('加载超时');
                    }
                }, 10000); // 10秒超时
                
            } catch (error) {
                console.error('加载内容时出错:', error);
                errorMessage.textContent = `错误: ${error.message}`;
                errorContainer.style.display = 'flex';
                contentFrame.style.display = 'none';
            }
        };
    </script>
</body>
</html>
